{
  "audit_timestamp": "2026-01-31T12:00:00Z",
  "auditor": "security-auditor",
  "scope": "Phase 2 - Gaps 001, 005, 006",
  "status": "PASS",
  "summary": "0 CRITICAL, 1 HIGH, 6 MEDIUM, 3 LOW vulnerabilities detected",
  "gaps_audited": [
    {
      "gap_id": "GAP-CHT-001",
      "description": "Validation prérequis réception chantier",
      "commit": "7f7ba2d",
      "files_count": 5,
      "files": [
        "backend/modules/chantiers/domain/services/prerequis_service.py",
        "backend/modules/chantiers/application/use_cases/change_statut.py",
        "backend/modules/chantiers/infrastructure/web/dependencies.py",
        "backend/modules/chantiers/infrastructure/web/chantier_routes.py",
        "backend/modules/chantiers/application/use_cases/__init__.py"
      ]
    },
    {
      "gap_id": "GAP-PLN-005",
      "description": "Permission Chef de Chantier - modification note uniquement",
      "commit": "b34bf02",
      "files_count": 7,
      "files": [
        "backend/modules/planning/adapters/controllers/planning_controller.py",
        "backend/modules/planning/adapters/controllers/planning_schemas.py",
        "backend/modules/planning/application/use_cases/__init__.py",
        "backend/modules/planning/application/use_cases/update_affectation_note.py",
        "backend/modules/planning/infrastructure/web/dependencies.py",
        "backend/modules/planning/infrastructure/web/planning_routes.py",
        "backend/tests/unit/planning/test_update_affectation_note_use_case.py"
      ]
    },
    {
      "gap_id": "GAP-PLN-006",
      "description": "Validation conflit absences (RG-PLN-007)",
      "commit": "a0efe35",
      "files_count": 1,
      "files": [
        "backend/modules/planning/application/use_cases/create_affectation.py"
      ]
    }
  ],
  "vulnerabilities": [
    {
      "severity": "HIGH",
      "file": "backend/modules/chantiers/application/use_cases/change_statut.py",
      "line": 167,
      "category": "auth",
      "message": "Audit trail incomplet : user_id=None lors du logging dans audit_logs",
      "description": "Le code injecte user_id=None dans AuditService.log_chantier_status_changed() au lieu d'utiliser l'utilisateur réel. Cela compromet la traçabilité RGPD et la détection d'actions malveillantes.",
      "remediation": "Injecter le user_id réel depuis le contexte de requête FastAPI (current_user_id). Modifier la signature de ChangeStatutUseCase.execute() pour accepter user_id en paramètre, ou utiliser un context manager pour récupérer l'utilisateur actuel.",
      "code_snippet": "self.audit_service.log_chantier_status_changed(\n    chantier_id=chantier.id,\n    user_id=None,  # TODO: Injecter depuis context utilisateur\n    old_status=ancien_statut,\n    new_status=str(chantier.statut),\n    ip_address=None,  # TODO: Injecter depuis request\n)",
      "impact": "RGPD : traçabilité insuffisante pour identifier l'auteur des modifications de statut. Impossible d'établir la responsabilité en cas d'incident."
    },
    {
      "severity": "MEDIUM",
      "file": "backend/modules/chantiers/application/use_cases/change_statut.py",
      "line": 170,
      "category": "rgpd",
      "message": "Audit trail incomplet : ip_address=None lors du logging",
      "description": "L'adresse IP de l'utilisateur n'est pas enregistrée dans les audit_logs, ce qui réduit la capacité de détection d'intrusion et de traçabilité géographique.",
      "remediation": "Injecter l'IP depuis le contexte de requête FastAPI. Utiliser request.client.host pour récupérer l'IP réelle (attention aux proxies, utiliser X-Forwarded-For si nécessaire).",
      "code_snippet": "ip_address=None,  # TODO: Injecter depuis request",
      "impact": "Traçabilité réduite pour la détection d'accès non autorisés depuis des localisations inhabituelles."
    },
    {
      "severity": "MEDIUM",
      "file": "backend/modules/chantiers/domain/services/prerequis_service.py",
      "line": 54,
      "category": "input_validation",
      "message": "Validation des prérequis formulaires insuffisante : hardcoded count < 3",
      "description": "Le code utilise un seuil hardcodé (3 formulaires minimum) au lieu de récupérer la configuration réelle des formulaires obligatoires. Cela rend la validation inefficace si les exigences métier changent.",
      "remediation": "Créer une table de configuration 'formulaires_prerequis_reception' en base de données ou utiliser un fichier de config pour définir les formulaires obligatoires par type de chantier. Remplacer le count < 3 par une vérification basée sur cette configuration.",
      "code_snippet": "if count < 3:  # Placeholder: 3 formulaires minimum\n    manquants.append(\n        f\"Formulaires manquants ({count}/3 minimum requis)\"\n    )",
      "impact": "Faible sécurité métier : un chantier pourrait être réceptionné sans les formulaires réglementaires requis (PV, conformité, etc.)."
    },
    {
      "severity": "MEDIUM",
      "file": "backend/modules/chantiers/infrastructure/web/dependencies.py",
      "line": 82,
      "category": "data_exposure",
      "message": "Graceful degradation peut masquer des erreurs critiques",
      "description": "Les try/except ImportError pour les repositories cross-module sont trop permissifs. Si un module est absent en production par erreur, la validation des prérequis sera silencieusement désactivée sans alerte.",
      "remediation": "Ajouter un logging WARNING ou ERROR explicite lors de l'échec d'import, et lever une exception en environnement production si les modules critiques (formulaires, signalements, pointages) ne sont pas disponibles. Utiliser une variable d'environnement STRICT_VALIDATION=true en production.",
      "code_snippet": "try:\n    from modules.formulaires.infrastructure.persistence import (\n        SQLAlchemyFormulaireRempliRepository\n    )\n    formulaire_repo = SQLAlchemyFormulaireRempliRepository(db)\nexcept ImportError:\n    logger.warning(\"FormulaireRempliRepository not available\")",
      "impact": "Risque de réception de chantiers sans validation complète en production si un module est absent par erreur de déploiement."
    },
    {
      "severity": "MEDIUM",
      "file": "backend/modules/chantiers/infrastructure/web/chantier_routes.py",
      "line": 603,
      "category": "data_exposure",
      "message": "Code de debug (print statements) présent en production",
      "description": "Multiples print() statements de debug qui exposent les données de requête dans les logs. Ces données peuvent contenir des informations sensibles (noms, adresses, contacts).",
      "remediation": "Remplacer tous les print() par logger.debug() et s'assurer que le niveau de log en production est INFO ou WARNING. Supprimer les print statements ou les envelopper dans if settings.DEBUG.",
      "code_snippet": "print(f\"[DEBUG] update_chantier called with request: {request}\")\nprint(f\"[DEBUG] request dict: {request.dict()}\")",
      "impact": "RGPD : exposition de données personnelles (contacts, adresses) dans les logs de production si mal configurés."
    },
    {
      "severity": "MEDIUM",
      "file": "backend/modules/planning/infrastructure/web/planning_routes.py",
      "line": 356,
      "category": "auth",
      "message": "Autorisation Chef de Chantier : requête inefficace (récupération de toutes les affectations)",
      "description": "Pour vérifier qu'un Chef peut modifier une note, le code récupère TOUTES les affectations sur une période de 2 ans (365 jours avant/après), ce qui est inefficace et peut exposer des données non nécessaires.",
      "remediation": "Créer une méthode repository.find_by_id(affectation_id) qui récupère uniquement l'affectation ciblée, puis vérifier le chantier_id. Cela réduit l'exposition de données et améliore les performances.",
      "code_snippet": "filters = PlanningFiltersRequest(\n    date_debut=today - timedelta(days=365),\n    date_fin=today + timedelta(days=365),\n)\naffectations = controller.get_planning(filters, current_user_id, current_user_role)",
      "impact": "Performance dégradée et exposition excessive de données (principe de minimisation RGPD non respecté)."
    },
    {
      "severity": "MEDIUM",
      "file": "backend/modules/planning/application/use_cases/create_affectation.py",
      "line": 167,
      "category": "input_validation",
      "message": "Validation conflit absences : comparaison hardcodée avec set Python",
      "description": "Le code utilise un set Python CHANTIERS_ABSENCES = {'CONGES', 'MALADIE', 'RTT', 'FORMATION'} pour identifier les chantiers d'absence. Cette liste devrait être en base de données ou configuration pour permettre l'ajout dynamique de nouveaux types d'absence.",
      "remediation": "Créer une table 'chantiers_systeme' avec un champ 'type' (absence, formation, etc.) et récupérer la liste dynamiquement. Ou utiliser un enum TypeChantier dans le domaine avec is_absence().",
      "code_snippet": "CHANTIERS_ABSENCES = {'CONGES', 'MALADIE', 'RTT', 'FORMATION'}\nchantier_cible = self.chantier_repo.find_by_id(dto.chantier_id)\nif chantier_cible and chantier_cible.code not in CHANTIERS_ABSENCES:",
      "impact": "Maintenabilité : ajout de nouveaux types d'absence nécessite modification du code au lieu d'une configuration."
    },
    {
      "severity": "LOW",
      "file": "backend/modules/chantiers/infrastructure/web/chantier_routes.py",
      "line": 747,
      "category": "data_exposure",
      "message": "Exception handler trop verbeux : exposition de stack trace",
      "description": "Le handler d'exception générique dans update_chantier() expose le type d'exception et le message complet, ce qui peut révéler des détails d'implémentation (noms de tables, chemins de fichiers).",
      "remediation": "En production, ne retourner qu'un message générique \"Internal server error\" et logger les détails complets côté serveur. Utiliser un middleware d'exception handling global.",
      "code_snippet": "except Exception as e:\n    import traceback\n    traceback.print_exc()\n    raise HTTPException(\n        status_code=status.HTTP_400_BAD_REQUEST,\n        detail=f\"Error updating chantier: {type(e).__name__}: {str(e)}\",\n    )",
      "impact": "Information disclosure : exposition de détails techniques qui peuvent aider un attaquant à cartographier l'application."
    },
    {
      "severity": "LOW",
      "file": "backend/modules/planning/infrastructure/web/planning_routes.py",
      "line": 348,
      "category": "auth",
      "message": "Logique d'autorisation Chef de Chantier pourrait être contournée avec role spoofing",
      "description": "La vérification if current_user_role == 'chef' dépend uniquement du token JWT. Si le mécanisme de génération de token est compromis ou si le rôle n'est pas revalidé côté serveur, un utilisateur pourrait s'auto-promouvoir.",
      "remediation": "S'assurer que get_current_user_role() récupère le rôle directement depuis la base de données et non depuis le token JWT. Ajouter une validation supplémentaire que l'utilisateur a bien le rôle 'chef' en base.",
      "code_snippet": "if current_user_role == 'chef':\n    # Verification que le Chef est responsable du chantier",
      "impact": "Faible si le système d'authentification est robuste, mais principe de défense en profondeur recommande de revalider les rôles critiques."
    },
    {
      "severity": "LOW",
      "file": "backend/modules/planning/application/use_cases/update_affectation_note.py",
      "line": 76,
      "category": "input_validation",
      "message": "Validation de note insuffisante : pas de limite de longueur",
      "description": "Le code accepte n'importe quelle longueur de note sans validation. Une note excessivement longue pourrait causer des problèmes de performance ou de stockage.",
      "remediation": "Ajouter une validation de longueur maximale (ex: 1000 caractères) avant d'enregistrer la note. Lever une ValueError si dépassement.",
      "code_snippet": "if note is None or note.strip() == \"\":\n    affectation.supprimer_note()\nelse:\n    affectation.ajouter_note(note)",
      "impact": "Faible risque de DoS ou problème de stockage si un utilisateur malveillant envoie des notes de plusieurs Mo."
    }
  ],
  "rgpd_compliance": {
    "audit_trail": "NON_COMPLIANT",
    "audit_trail_details": "L'audit trail est incomplet (user_id et ip_address = None dans GAP-CHT-001). Article 30 RGPD nécessite un registre des traitements avec identification de l'auteur. IMPACT : Impossible d'identifier l'auteur des changements de statut chantier.",
    "data_minimization": "COMPLIANT",
    "data_minimization_details": "Principe de minimisation respecté dans GAP-PLN-005 (seule la note est modifiable par les Chefs). Exception : planning_routes.py ligne 356 récupère trop de données (toutes les affectations sur 2 ans au lieu d'une seule).",
    "user_consent": "COMPLIANT",
    "user_consent_details": "Pas de traitement de données personnelles nécessitant un consentement explicite dans ces gaps. Les autorisations sont basées sur les rôles (RBAC).",
    "recommendations": [
      "Implémenter l'injection de user_id et ip_address dans ChangeStatutUseCase (GAP-CHT-001)",
      "Ajouter une méthode repository.find_by_id() pour récupérer une seule affectation au lieu de toutes (GAP-PLN-005)",
      "Documenter la durée de rétention des audit_logs (RGPD Article 5)"
    ]
  },
  "security_summary": {
    "injection": "PASS (0 vulnerabilities) - Aucune vulnérabilité d'injection SQL/command/XSS détectée. SQLAlchemy ORM utilisé correctement avec paramètres liés.",
    "authentication_authorization": "PASS avec réserves (1 HIGH, 2 LOW) - RBAC correctement implémenté mais audit trail incomplet (user_id=None). Autorisation Chef de Chantier correcte dans GAP-PLN-005 mais inefficace (récupération de toutes les affectations).",
    "data_exposure": "PASS avec réserves (3 MEDIUM, 1 LOW) - Print statements de debug en production, exception handlers verbeux, graceful degradation trop permissive.",
    "input_validation": "PASS avec réserves (2 MEDIUM, 1 LOW) - Validation prérequis formulaires hardcodée, pas de limite longueur note, liste absences hardcodée.",
    "error_handling": "PASS avec réserves - Exception handlers génériques exposent trop de détails techniques.",
    "rgpd": "PARTIAL (1 MEDIUM, 1 HIGH) - Audit trail incomplet (user_id et ip_address manquants). Minimisation des données respectée sauf dans une route.",
    "secrets": "PASS (0 vulnerabilities) - Aucun secret hardcodé détecté.",
    "dependencies": "NOT_AUDITED - Analyse des dépendances hors scope de cet audit."
  },
  "testing_recommendations": [
    "Tester la validation des prérequis de réception avec formulaires manquants (GAP-CHT-001)",
    "Tester le bypass d'autorisation Chef de Chantier en modifiant le chantier_id (GAP-PLN-005)",
    "Tester la création d'affectation pendant une absence pour valider RG-PLN-007 (GAP-PLN-006)",
    "Tester l'injection de notes excessivement longues (> 10000 caractères)",
    "Tester le comportement en production si un module cross-module est absent (formulaires, signalements)"
  ],
  "remediation_priority": [
    {
      "priority": "P0 (URGENT)",
      "issue": "Audit trail incomplet (user_id=None, ip_address=None)",
      "files": ["backend/modules/chantiers/application/use_cases/change_statut.py"],
      "remediation": "Injecter user_id et ip_address depuis le contexte FastAPI. Modifier la signature de ChangeStatutUseCase.execute()."
    },
    {
      "priority": "P1 (HIGH)",
      "issue": "Print statements de debug en production",
      "files": ["backend/modules/chantiers/infrastructure/web/chantier_routes.py", "backend/modules/chantiers/application/use_cases/update_chantier.py"],
      "remediation": "Remplacer tous les print() par logger.debug() et vérifier la configuration des logs en production."
    },
    {
      "priority": "P1 (HIGH)",
      "issue": "Autorisation Chef inefficace (récupération de toutes les affectations)",
      "files": ["backend/modules/planning/infrastructure/web/planning_routes.py"],
      "remediation": "Créer une méthode repository.find_by_id() et récupérer uniquement l'affectation ciblée."
    },
    {
      "priority": "P2 (MEDIUM)",
      "issue": "Validation prérequis formulaires hardcodée",
      "files": ["backend/modules/chantiers/domain/services/prerequis_service.py"],
      "remediation": "Créer une configuration dynamique des formulaires obligatoires (DB ou config file)."
    },
    {
      "priority": "P2 (MEDIUM)",
      "issue": "Graceful degradation trop permissive",
      "files": ["backend/modules/chantiers/infrastructure/web/dependencies.py"],
      "remediation": "Ajouter logging WARNING et lever exception en production si modules critiques absents."
    }
  ],
  "conclusion": "L'audit révèle 0 vulnérabilités CRITICAL et 1 HIGH. Le statut global est PASS car aucune faille critique exploitable n'a été détectée. Cependant, 7 issues MEDIUM/LOW doivent être corrigées pour garantir la conformité RGPD complète (audit trail) et respecter les bonnes pratiques de sécurité (minimisation données, validation robuste). Les 3 gaps implémentent correctement la logique métier et l'autorisation RBAC, mais souffrent de lacunes en traçabilité et validation.",
  "next_steps": [
    "Corriger l'audit trail incomplet (user_id/ip_address) - URGENT",
    "Supprimer les print() de debug et configurer les logs correctement",
    "Optimiser l'autorisation Chef de Chantier avec find_by_id()",
    "Ajouter tests de sécurité pour validation prérequis et autorisations",
    "Documenter la politique de rétention des audit_logs (RGPD)"
  ]
}
